generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(cuid())
  email                    String                    @unique
  password                 String
  name                     String
  role                     UserRole                  @default(STUDENT)
  verified                 Boolean                   @default(false)
  resetToken               String?
  resetTokenExpiry         DateTime?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  // Profile fields
  phone                    String?
  birthDate                String?
  profession               String?
  profileImageUrl          String?
  address                  String?
  city                     String?
  state                    String?
  zipCode                  String?
  country                  String?
  orders                   Order[]
  collaboratorApplications CollaboratorApplication[]
  reviewedApplications     CollaboratorApplication[] @relation("ReviewerApplications")
  evaluations              Evaluation[]
  notes                    Note[]
  interviews               Interview[]
  certificates             Certificate[]
  library                  Library[]
  customPapers             CustomPaper[]
  customPaperMessages      CustomPaperMessage[]
  courseProgress           CourseProgress[]
  courseEnrollments        CourseEnrollment[]
  blogPosts                BlogPost[]
  comments                 Comment[]
  likes                    Like[]
}

enum UserRole {
  ADMIN
  STUDENT
  COLLABORATOR
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELED
}

enum PaymentMethod {
  PIX
  BOLETO
  CREDIT_CARD
  DEBIT_CARD
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  CONFIRMED
  OVERDUE
  REFUNDED
  FAILED
  CANCELED
}

enum PaperType {
  ARTICLE
  REVIEW
  THESIS
  DISSERTATION
  PROJECT
  ESSAY
  SUMMARY
  MONOGRAPHY
  CASE_STUDY
}

enum AcademicArea {
  ADMINISTRATION
  LAW
  EDUCATION
  ENGINEERING
  PSYCHOLOGY
  HEALTH
  ACCOUNTING
  ARTS
  ECONOMICS
  SOCIAL_SCIENCES
  OTHER
  EXACT_SCIENCES
  BIOLOGICAL_SCIENCES
  HEALTH_SCIENCES
  APPLIED_SOCIAL_SCIENCES
  HUMANITIES
  LANGUAGES
  AGRICULTURAL_SCIENCES
  MULTIDISCIPLINARY
}

enum CourseStatus {
  ACTIVE
  INACTIVE
}

enum LibraryItemType {
  PAPER
  EBOOK
  COURSE_MATERIAL
}

enum ApplicationStatus {
  PENDING
  INTERVIEWING
  APPROVED
  REJECTED
}

enum ApplicationStage {
  RECEIVED
  SCREENING
  INTERVIEW
  TECHNICAL_TEST
  FINAL_REVIEW
  OFFER
  HIRED
}

enum EvaluationRecommendation {
  STRONG_HIRE
  HIRE
  MAYBE
  NO_HIRE
  STRONG_NO_HIRE
}

enum InterviewType {
  PHONE_SCREENING
  TECHNICAL
  BEHAVIORAL
  FINAL
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InterviewResult {
  PASS
  FAIL
  UNDECIDED
}

enum MessageStatus {
  UNREAD
  READ
  ARCHIVED
}

enum CustomPaperStatus {
  REQUESTED // Initial request from student
  QUOTED // Admin provided quote
  APPROVED // Student approved quote
  IN_PROGRESS // Work in progress
  REVIEW // Under review by admin
  COMPLETED // Delivered to student
  CANCELLED // Cancelled by student or admin
  REJECTED // Rejected by admin
}

enum CustomPaperUrgency {
  NORMAL // 7+ days
  URGENT // 3-6 days
  VERY_URGENT // 1-2 days
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum LegalType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  COOKIES_POLICY
  LGPD_COMPLIANCE
}

model Order {
  id              String         @id @default(cuid())
  userId          String?
  user            User?          @relation(fields: [userId], references: [id])
  items           OrderItem[]
  totalAmount     Int
  status          OrderStatus    @default(PENDING)
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus  @default(PENDING)
  customerName    String
  customerEmail   String
  customerCpfCnpj String
  customerPhone   String?
  pixCode         String?
  boletoUrl       String?
  customPaper     CustomPaper?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id])
  title       String
  description String?
  price       Int
  paperId     String?
  paper       Paper?  @relation(fields: [paperId], references: [id])
  courseId    String?
  course      Course? @relation(fields: [courseId], references: [id])
  ebookId     String?
  ebook       Ebook?  @relation(fields: [ebookId], references: [id])
}

model Paper {
  id           String       @id @default(cuid())
  title        String
  description  String       @db.Text
  paperType    PaperType
  academicArea AcademicArea
  price        Int
  pageCount    Int
  authorName   String
  language     String       @default("pt-BR")
  keywords     String?
  previewUrl   String?
  fileUrl      String
  thumbnailUrl String?
  isFree       Boolean      @default(false)
  createdAt    DateTime     @default(now())
  orderItems   OrderItem[]
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model Course {
  id             String             @id @default(cuid())
  title          String
  description    String             @db.Text
  academicArea   AcademicArea
  instructorName String
  instructorBio  String?
  price          Int
  duration       Int
  level          CourseLevel        @default(BEGINNER)
  thumbnailUrl   String?
  videoUrl       String?
  status         CourseStatus       @default(ACTIVE)
  isFeatured     Boolean            @default(true)
  createdAt      DateTime           @default(now())
  orderItems     OrderItem[]
  certificates   Certificate[]
  modules        CourseModule[]
  enrollments    CourseEnrollment[]

  @@index([isFeatured])
}

model Ebook {
  id           String       @id @default(cuid())
  title        String
  description  String       @db.Text
  academicArea AcademicArea
  authorName   String
  price        Int
  pageCount    Int
  fileUrl      String // Mantido para compatibilidade, será removido após migração
  coverUrl     String?
  files        EbookFile[]
  createdAt    DateTime     @default(now())
  orderItems   OrderItem[]
}

model EbookFile {
  id        String   @id @default(cuid())
  ebookId   String
  ebook     Ebook    @relation(fields: [ebookId], references: [id], onDelete: Cascade)
  fileUrl   String
  fileName  String
  fileSize  Int?
  createdAt DateTime @default(now())

  @@index([ebookId])
}

model Certificate {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  courseId          String
  course            Course   @relation(fields: [courseId], references: [id])
  certificateNumber String   @unique
  grade             Int
  completionDate    DateTime
  qrCodeUrl         String
  createdAt         DateTime @default(now())
}

model Library {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id])
  itemType    LibraryItemType
  itemId      String
  downloadUrl String
  expiresAt   DateTime?
  createdAt   DateTime        @default(now())
}

model Category {
  id          String                   @id @default(cuid())
  name        String                   @unique
  slug        String                   @unique
  posts       BlogPost[]
  subscribers NewsletterSubscription[]
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  posts     BlogTag[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model BlogPost {
  id              String             @id @default(cuid())
  title           String
  content         String             @db.Text
  slug            String             @unique
  excerpt         String?
  coverImageUrl   String?
  published       Boolean            @default(false)
  status          PostStatus         @default(DRAFT)
  publishedAt     DateTime?
  authorId        String
  author          User               @relation(fields: [authorId], references: [id])
  categoryId      String?
  category        Category?          @relation(fields: [categoryId], references: [id])
  tags            BlogTag[]
  comments        Comment[]
  likes           Like[]
  views           Int                @default(0)
  // SEO fields
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]
  ogImage         String?
  canonicalUrl    String?
  readingTime     Int? // minutos
  // Analytics relations
  analytics       PostAnalytics[]
  notifications   PostNotification[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model BlogTag {
  postId String
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId  String
  tag    Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
}

model Comment {
  id        String    @id @default(cuid())
  content   String    @db.Text
  postId    String
  post      BlogPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  approved  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model CollaboratorApplication {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Dados Pessoais
  fullName  String
  email     String
  phone     String
  cpf       String?   @unique
  birthDate DateTime?

  // Endereço
  zipCode String?
  address String?
  city    String?
  state   String?

  // Dados Profissionais
  area           String
  education      String? @db.Text
  experience     String  @db.Text
  skills         Json? // Array de skills
  availability   String
  expectedSalary Float?

  // Documentos
  resumeUrl     String?
  portfolioUrls Json? // Array de URLs
  linkedin      String?
  github        String?

  // Metadados
  status ApplicationStatus @default(PENDING)
  stage  ApplicationStage  @default(RECEIVED)
  score  Int? // Pontuação da avaliação

  // Avaliação
  evaluations Evaluation[]
  notes       Note[]
  interviews  Interview[]

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  reviewedAt DateTime?
  approvedAt DateTime?
  rejectedAt DateTime?

  // Relacionamentos
  reviewer   User?   @relation("ReviewerApplications", fields: [reviewerId], references: [id])
  reviewerId String?

  @@index([status, stage])
  @@index([createdAt])
  @@index([userId])
}

model Message {
  id           String        @id @default(cuid())
  name         String
  email        String
  phone        String?
  subject      String
  message      String        @db.Text
  status       MessageStatus @default(UNREAD)
  replied      Boolean       @default(false)
  repliedAt    DateTime?
  replyContent String?       @db.Text
  assignedTo   String?
  priority     Priority      @default(NORMAL)
  category     String?
  metadata     Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([status, createdAt])
  @@index([email])
  @@index([priority])
  @@index([assignedTo])
}

model LegalDocument {
  id          String    @id @default(cuid())
  type        LegalType
  title       String
  content     String    @db.Text
  version     String
  active      Boolean   @default(true)
  publishedBy String // ID do admin que publicou
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([type, active])
  @@index([type, active])
  @@index([publishedBy])
}

model MessageTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  content   String   @db.Text
  variables String[] // Variáveis disponíveis [name, email, etc]
  category  String?
  createdBy String // ID do admin que criou
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([createdBy])
}

model DownloadTracking {
  id           String   @id @default(cuid())
  userId       String
  itemId       String
  itemType     String
  downloadedAt DateTime @default(now())

  @@index([userId])
  @@index([itemId])
  @@index([downloadedAt])
}

model CustomPaper {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Request details
  title        String
  description  String             @db.Text
  paperType    PaperType
  academicArea AcademicArea
  pageCount    Int
  deadline     DateTime
  urgency      CustomPaperUrgency // NORMAL, URGENT, VERY_URGENT
  requirements String             @db.Text
  keywords     String?
  references   String?            @db.Text

  // Files
  requirementFiles String[] // Array of URLs for requirement documents
  deliveryFiles    String[] // Array of URLs for delivered documents

  // Pricing
  quotedPrice   Int? // Price in cents
  finalPrice    Int? // Final agreed price
  paymentStatus PaymentStatus @default(PENDING)

  // Status
  status          CustomPaperStatus @default(REQUESTED)
  adminNotes      String?           @db.Text
  rejectionReason String?

  // Tracking
  requestedAt DateTime  @default(now())
  quotedAt    DateTime?
  approvedAt  DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  messages CustomPaperMessage[]
  orderId  String?              @unique
  order    Order?               @relation(fields: [orderId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([deadline])
}

model CustomPaperMessage {
  id            String      @id @default(cuid())
  customPaperId String
  customPaper   CustomPaper @relation(fields: [customPaperId], references: [id])

  senderId String
  sender   User   @relation(fields: [senderId], references: [id])

  content     String   @db.Text
  attachments String[] // URLs for attached files
  isFromAdmin Boolean
  isRead      Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([customPaperId])
  @@index([senderId])
}

model CourseModule {
  id          String         @id @default(cuid())
  courseId    String
  course      Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title       String
  description String?
  order       Int
  lessons     CourseLesson[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([courseId])
}

model CourseLesson {
  id          String           @id @default(cuid())
  moduleId    String
  module      CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title       String
  description String?          @db.Text
  videoUrl    String?
  content     String?          @db.Text
  duration    Int? // in minutes
  order       Int
  isEnabled   Boolean          @default(true)
  attachments String[] // Array of file URLs (PDFs, Word, etc)
  progress    CourseProgress[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([moduleId])
}

model CourseProgress {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  lessonId    String
  lesson      CourseLesson @relation(fields: [lessonId], references: [id])
  completed   Boolean      @default(false)
  watchTime   Int          @default(0) // seconds watched
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model CourseEnrollment {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  courseId    String
  course      Course    @relation(fields: [courseId], references: [id])
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  progress    Int       @default(0) // percentage

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model PostAnalytics {
  id            String   @id @default(cuid())
  postId        String
  post          BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  date          DateTime
  views         Int      @default(0)
  uniqueViews   Int      @default(0)
  shares        Int      @default(0)
  avgTimeOnPage Int      @default(0) // seconds
  bounceRate    Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([postId, date])
  @@index([date])
  @@index([postId])
}

model NewsletterSubscriber {
  id            String                   @id @default(cuid())
  email         String                   @unique
  name          String?
  active        Boolean                  @default(true)
  subscriptions NewsletterSubscription[]
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  @@index([email])
  @@index([active])
}

model NewsletterSubscription {
  subscriberId String
  subscriber   NewsletterSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  categoryId   String
  category     Category             @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt    DateTime             @default(now())

  @@id([subscriberId, categoryId])
  @@index([subscriberId])
  @@index([categoryId])
}

model PostNotification {
  id              String    @id @default(cuid())
  postId          String
  post            BlogPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  sentAt          DateTime?
  subscriberCount Int       @default(0)
  subject         String?
  emailContent    String?   @db.Text
  createdAt       DateTime  @default(now())

  @@index([postId])
  @@index([sentAt])
}

model Evaluation {
  id            String                  @id @default(cuid())
  applicationId String
  application   CollaboratorApplication @relation(fields: [applicationId], references: [id])
  evaluatorId   String
  evaluator     User                    @relation(fields: [evaluatorId], references: [id])

  // Critérios de Avaliação
  experienceScore  Int // 0-10
  skillsScore      Int // 0-10
  educationScore   Int // 0-10
  culturalFitScore Int // 0-10

  totalScore     Int
  recommendation EvaluationRecommendation
  comments       String                   @db.Text

  createdAt DateTime @default(now())
}

model Note {
  id            String                  @id @default(cuid())
  applicationId String
  application   CollaboratorApplication @relation(fields: [applicationId], references: [id])
  authorId      String
  author        User                    @relation(fields: [authorId], references: [id])
  content       String                  @db.Text
  isPrivate     Boolean                 @default(false)
  createdAt     DateTime                @default(now())
}

model Interview {
  id            String                  @id @default(cuid())
  applicationId String
  application   CollaboratorApplication @relation(fields: [applicationId], references: [id])

  scheduledAt DateTime
  duration    Int // em minutos
  type        InterviewType
  location    String?
  meetingUrl  String?

  interviewerId String
  interviewer   User   @relation(fields: [interviewerId], references: [id])

  status   InterviewStatus  @default(SCHEDULED)
  feedback String?          @db.Text
  result   InterviewResult?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiIntegration {
  id          String   @id @default(cuid())
  name        String   @unique // Nome da integração (ex: "asaas", "stripe", etc)
  displayName String // Nome de exibição
  apiKey      String // Chave da API (será criptografada)
  apiSecret   String? // Secret da API se necessário
  environment String   @default("production") // production ou sandbox
  isActive    Boolean  @default(true)
  metadata    Json? // Configurações adicionais em JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}
